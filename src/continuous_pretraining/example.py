#!/usr/bin/env python3
"""
继续预训练示例脚本
演示如何使用CPTTrainer对Qwen2.5模型进行继续预训练
"""

import os
import sys
from pathlib import Path

# 添加项目根目录到Python路径
project_root = Path(__file__).resolve().parent.parent.parent
sys.path.append(str(project_root))

from src.continuous_pretraining.cpt_trainer import CPTTrainer
from src.configs.cpt_config import CPTConfig


def main():
    """继续预训练示例"""
    
    # 创建配置
    config = CPTConfig()
    
    # 自定义配置
    config.model.model_name_or_path = "Qwen/Qwen2.5-7B"
    config.model.max_length = 2048
    config.model.use_flash_attention = True
    config.model.torch_dtype = "bfloat16"
    
    config.training.learning_rate = 5e-5
    config.training.num_train_epochs = 3
    config.training.per_device_train_batch_size = 4
    config.training.gradient_accumulation_steps = 8
    config.training.lr_scheduler_type = "cosine"
    config.training.warmup_ratio = 0.05
    config.training.output_dir = "./cpt_example_output"
    config.training.logging_steps = 10
    config.training.save_steps = 500
    config.training.bf16 = True
    config.training.gradient_checkpointing = True
    
    config.data.max_train_samples = 1000  # 限制样本数量用于示例
    
    # 准备训练数据（示例）
    train_texts = [
        "旅游是一种体验不同文化和风景的方式。",
        "选择合适的旅游目的地需要考虑多方面因素。",
        "旅游规划包括行程安排、住宿选择和预算控制。",
        "自然景观旅游包括山川、湖泊、森林和海洋。",
        "文化旅游涉及历史遗迹、博物馆和当地传统。",
        "旅游行业的发展促进了经济增长和文化交流。",
        "可持续旅游强调环境保护和当地社区的利益。",
        "背包客旅游是一种经济实惠且自由的旅行方式。",
        "家庭旅游需要考虑不同年龄段成员的需求。",
        "商务旅游结合了工作和休闲的元素。",
        "旅游保险是旅行前的重要准备之一。",
        "旅游摄影记录了旅途中的美好瞬间。",
        "美食旅游探索不同地区的特色菜肴和饮食文化。",
        "旅游淡季出行可以享受更少的人流和更低的价格。",
        "旅游攻略提供了目的地的实用信息和建议。",
        "旅游安全意识是确保愉快旅行的关键。",
        "旅游纪念品是旅行回忆的 tangible 表达。",
        "旅游体验的分享可以激发他人的旅行灵感。",
        "旅游行业的发展也带来了一些环境挑战。",
        "旅游教育可以帮助游客更好地尊重当地文化。",
        "旅游目的地的选择反映了个人兴趣和偏好。",
        "旅游行程的灵活性可以应对突发情况。",
        "旅游住宿的选择包括酒店、民宿和青年旅社。",
        "旅游交通方式包括飞机、火车、汽车和轮船。",
        "旅游签证是国际旅行的重要准备工作。",
        "旅游保险涵盖了医疗、行李和行程取消等风险。",
        "旅游摄影技巧可以帮助捕捉更好的照片。",
        "旅游博客是分享旅行经验和建议的平台。",
        "旅游季节的选择影响目的地的景色和活动。",
        "旅游预算的合理分配确保旅行的舒适度。",
        "旅游装备的选择取决于目的地的气候和活动。",
        "旅游语言的准备有助于与当地人交流。",
        "旅游文化的尊重是负责任旅行的表现。",
        "旅游环境的保护是可持续发展的要求。",
        "旅游体验的质量取决于准备和心态。",
        "旅游回忆是旅行中最宝贵的财富。",
        "旅游行业的发展需要政府、企业和游客的共同努力。",
        "旅游规划工具简化了行程安排的过程。",
        "旅游社交活动可以结识志同道合的朋友。",
        "旅游目的地的多样性满足了不同的旅行需求。",
        "旅游安全措施包括健康检查和紧急联系。",
        "旅游纪念品的选择应考虑当地特色和实用性。",
        "旅游摄影的构图技巧提升了照片的艺术性。",
        "旅游攻略的可靠性需要多方验证。",
        "旅游淡季的优惠活动提供了性价比高的选择。",
        "旅游体验的深度比广度更有意义。",
        "旅游行业的创新提升了游客的体验。",
        "旅游文化的理解促进了国际间的和谐。",
        "旅游环境的保护需要每个人的参与。",
        "旅游回忆的分享可以传递快乐和启发。",
        "旅游规划的时间安排要合理分配。",
        "旅游装备的轻量化减轻了旅行的负担。",
        "旅游语言的学习增加了旅行的乐趣。",
        "旅游文化的体验丰富了人生的视野。",
        "旅游环境的可持续性是未来发展的方向。",
        "旅游体验的个性化满足了不同的需求。",
        "旅游行业的服务质量影响了游客的满意度。",
        "旅游目的地的保护是共同的责任。",
        "旅游回忆的整理是旅行后的美好工作。",
        "旅游规划的应用程序提供了便捷的工具。",
        "旅游社交的体验扩展了人际网络。",
        "旅游目的地的探索带来了惊喜和发现。",
        "旅游安全的意识是旅行的基本保障。",
        "旅游纪念品的故事增加了旅行的意义。",
        "旅游摄影的后期处理提升了照片效果。",
        "旅游攻略的细节决定了旅行的顺利程度。",
        "旅游淡季的宁静提供了不同的体验。",
        "旅游体验的反思有助于个人成长。",
        "旅游行业的发展需要平衡经济效益和环境保护。",
        "旅游文化的多样性是世界的宝贵财富。",
        "旅游环境的保护措施需要长期坚持。",
        "旅游回忆的保存方式多种多样。",
        "旅游规划的灵活性应对了变化的需求。",
        "旅游装备的功能性提高了旅行的舒适度。",
        "旅游语言的基本交流能力很有帮助。",
        "旅游文化的体验是旅行的重要部分。",
        "旅游环境的可持续性需要全球合作。",
        "旅游体验的深度和质量比数量更重要。",
        "旅游行业的服务标准需要不断提高。",
        "旅游目的地的保护是长远发展的基础。",
        "旅游回忆的分享可以激发他人的旅行热情。",
        "旅游规划的工具选择适合个人需求。",
        "旅游社交的机会丰富了旅行体验。",
        "旅游目的地的独特性吸引了游客。",
        "旅游安全的预防措施是必要的。",
        "旅游纪念品的选择应考虑环保因素。",
        "旅游摄影的技巧可以通过学习提高。",
        "旅游攻略的信息来源要可靠。",
        "旅游淡季的旅行有不同的魅力。",
        "旅游体验的收获因人而异。",
        "旅游行业的发展趋势值得关注。",
        "旅游文化的理解促进了国际友谊。",
        "旅游环境的保护是每个人的责任。",
        "旅游回忆的价值随着时间的推移而增加。",
        "旅游规划的时间管理很重要。",
        "旅游装备的选择要考虑实用性和便携性。",
        "旅游语言的学习增加了旅行的深度。",
        "旅游文化的尊重是文明旅行的表现。",
        "旅游环境的保护措施需要科学规划。",
        "旅游体验的质量取决于准备和态度。",
        "旅游行业的服务创新提升了竞争力。",
        "旅游目的地的可持续发展是关键。",
        "旅游回忆的保存技术不断进步。",
        "旅游规划的应用程序提供了个性化服务。",
        "旅游社交的体验可以带来长期友谊。",
        "旅游目的地的探索需要开放的心态。",
        "旅游安全的准备包括应急计划。",
        "旅游纪念品的文化价值大于物质价值。",
        "旅游摄影的艺术性需要创意和技巧。",
        "旅游攻略的实用性是选择的标准。",
        "旅游淡季的旅行可以更深入地了解当地。",
        "旅游体验的反思有助于未来的旅行规划。",
        "旅游行业的发展需要多方合作。",
        "旅游文化的交流促进了相互理解。",
        "旅游环境的保护是可持续旅游的核心。",
        "旅游回忆的分享方式随着技术发展而多样化。",
        "旅游规划的效率影响旅行的质量。",
        "旅游装备的选择要考虑目的地的特点。",
        "旅游语言的基本问候语很有用。",
        "旅游文化的体验丰富了人生阅历。",
        "旅游环境的保护需要长期投入。",
        "旅游体验的个性化是未来的趋势。",
        "旅游行业的服务质量需要持续改进。",
        "旅游目的地的保护需要游客的参与。",
        "旅游回忆的整理是旅行后的美好回忆。",
        "旅游规划的工具选择要适合个人习惯。",
        "旅游社交的体验可以扩展视野。",
        "旅游目的地的独特性是其魅力所在。",
        "旅游安全的意识需要时刻保持。",
        "旅游纪念品的选择应考虑文化意义。",
        "旅游摄影的构图技巧可以通过实践提高。",
        "旅游攻略的更新频率很重要。",
        "旅游淡季的旅行有不同的体验。",
        "旅游体验的收获可以通过分享放大。",
        "旅游行业的发展需要创新思维。",
        "旅游文化的理解促进了世界和平。",
        "旅游环境的保护是未来发展的基础。",
        "旅游回忆的价值在于情感连接。",
        "旅游规划的时间安排要合理。",
        "旅游装备的功能性提高了旅行效率。",
        "旅游语言的学习增加了旅行的乐趣。",
        "旅游文化的体验是旅行的重要收获。",
        "旅游环境的可持续性需要全球意识。",
        "旅游体验的深度决定了旅行的意义。",
        "旅游行业的服务标准需要国际化。",
        "旅游目的地的保护是共同的责任。",
        "旅游回忆的分享可以传递正能量。",
        "旅游规划的应用程序提供了便利。",
        "旅游社交的体验丰富了人际关系。",
        "旅游目的地的探索带来了新的认识。",
        "旅游安全的准备是旅行的基础。",
        "旅游纪念品的故事增加了旅行的深度。",
        "旅游摄影的后期处理是创作的一部分。",
        "旅游攻略的细节决定了旅行的质量。",
        "旅游淡季的宁静提供了思考的空间。",
        "旅游体验的反思有助于个人发展。",
        "旅游行业的发展需要平衡各方利益。",
        "旅游文化的多样性是世界的宝藏。",
        "旅游环境的保护需要科学方法。",
        "旅游回忆的保存方式反映了个人风格。",
        "旅游规划的灵活性应对了不确定性。",
        "旅游装备的选择要考虑轻便和实用。",
        "旅游语言的基本交流能力很有价值。",
        "旅游文化的尊重是国际公民的素养。",
        "旅游环境的保护措施需要持续改进。",
        "旅游体验的质量取决于准备和心态。",
        "旅游行业的服务创新需要客户导向。",
        "旅游目的地的可持续发展需要长远规划。",
        "旅游回忆的分享技术随着时代发展。",
        "旅游规划的工具选择要考虑易用性。",
        "旅游社交的机会可以带来意想不到的收获。",
        "旅游目的地的独特性需要保护和发展。",
        "旅游安全的预防措施需要全面考虑。",
        "旅游纪念品的选择应考虑当地特色。",
        "旅游摄影的技巧可以通过学习掌握。",
        "旅游攻略的信息来源要多样化。",
        "旅游淡季的旅行可以更深入体验当地生活。",
        "旅游体验的收获可以通过记录保存。",
        "旅游行业的发展趋势需要密切关注。",
        "旅游文化的理解促进了跨文化交流。",
        "旅游环境的保护是每个人的责任。",
        "旅游回忆的价值随着时间增长。",
        "旅游规划的时间管理影响旅行体验。",
        "旅游装备的选择要考虑多功能性。",
        "旅游语言的学习增加了旅行的深度。",
        "旅游文化的体验是旅行的重要部分。",
        "旅游环境的可持续性需要全球合作。",
        "旅游体验的深度和质量比数量更重要。",
        "旅游行业的服务标准需要不断提高。",
        "旅游目的地的保护是长远发展的基础。",
        "旅游回忆的分享可以激发他人的旅行热情。",
        "旅游规划的工具选择要适合个人需求。",
        "旅游社交的体验可以带来长期友谊。",
        "旅游目的地的探索需要开放的心态。",
        "旅游安全的准备包括应急计划。",
        "旅游纪念品的文化价值大于物质价值。",
        "旅游摄影的艺术性需要创意和技巧。",
        "旅游攻略的实用性是选择的标准。",
        "旅游淡季的旅行可以更深入地了解当地。",
        "旅游体验的反思有助于未来的旅行规划。",
        "旅游行业的发展需要多方合作。",
        "旅游文化的交流促进了相互理解。",
        "旅游环境的保护是可持续旅游的核心。",
        "旅游回忆的分享方式随着技术发展而多样化。",
        "旅游规划的效率影响旅行的质量。",
        "旅游装备的选择要考虑目的地的特点。",
        "旅游语言的基本问候语很有用。",
        "旅游文化的体验丰富了人生阅历。",
        "旅游环境的保护需要长期投入。",
        "旅游体验的个性化是未来的趋势。",
        "旅游行业的服务质量需要持续改进。",
        "旅游目的地的保护需要游客的参与。",
        "旅游回忆的整理是旅行后的美好回忆。",
        "旅游规划的工具选择要适合个人习惯。",
        "旅游社交的体验可以扩展视野。",
        "旅游目的地的独特性是其魅力所在。",
        "旅游安全的意识需要时刻保持。",
        "旅游纪念品的选择应考虑文化意义。",
        "旅游摄影的构图技巧可以通过实践提高。",
        "旅游攻略的更新频率很重要。",
        "旅游淡季的旅行有不同的体验。",
        "旅游体验的收获可以通过分享放大。",
        "旅游行业的发展需要创新思维。",
        "旅游文化的理解促进了世界和平。",
        "旅游环境的保护是未来发展的基础。",
        "旅游回忆的价值在于情感连接。",
        "旅游规划的时间安排要合理。",
        "旅游装备的功能性提高了旅行效率。",
        "旅游语言的学习增加了旅行的乐趣。",
        "旅游文化的体验是旅行的重要收获。",
        "旅游环境的可持续性需要全球意识。",
        "旅游体验的深度决定了旅行的意义。",
        "旅游行业的服务标准需要国际化。",
        "旅游目的地的保护是共同的责任。",
        "旅游回忆的分享可以传递正能量。",
        "旅游规划的应用程序提供了便利。",
        "旅游社交的体验丰富了人际关系。",
        "旅游目的地的探索带来了新的认识。",
        "旅游安全的准备是旅行的基础。",
        "旅游纪念品的故事增加了旅行的深度。",
        "旅游摄影的后期处理是创作的一部分。",
        "旅游攻略的细节决定了旅行的质量。",
        "旅游淡季的宁静提供了思考的空间。",
        "旅游体验的反思有助于个人发展。",
        "旅游行业的发展需要平衡各方利益。",
        "旅游文化的多样性是世界的宝藏。",
        "旅游环境的保护需要科学方法。",
        "旅游回忆的保存方式反映了个人风格。",
        "旅游规划的灵活性应对了不确定性。",
        "旅游装备的选择要考虑轻便和实用。",
        "旅游语言的基本交流能力很有价值。",
        "旅游文化的尊重是国际公民的素养。",
        "旅游环境的保护措施需要持续改进。",
        "旅游体验的质量取决于准备和心态。",
        "旅游行业的服务创新需要客户导向。",
        "旅游目的地的可持续发展需要长远规划。",
        "旅游回忆的分享技术随着时代发展。",
        "旅游规划的工具选择要考虑易用性。",
        "旅游社交的机会可以带来意想不到的收获。",
        "旅游目的地的独特性需要保护和发展。",
        "旅游安全的预防措施需要全面考虑。",
        "旅游纪念品的选择应考虑当地特色。",
        "旅游摄影的技巧可以通过学习掌握。",
        "旅游攻略的信息来源要多样化。",
        "旅游淡季的旅行可以更深入体验当地生活。",
        "旅游体验的收获可以通过记录保存。"
    ]
    
    # 准备评估数据（示例）
    eval_texts = [
        "旅游是一种探索世界的方式。",
        "旅游规划需要考虑预算和时间。",
        "旅游体验的质量取决于准备和心态。",
        "旅游环境的保护是每个人的责任。",
        "旅游回忆是旅行中最宝贵的财富。"
    ]
    
    # 创建训练器
    trainer = CPTTrainer(config)
    
    # 开始训练
    try:
        final_loss = trainer.train(train_texts, eval_texts)
        print(f"训练完成，最终损失: {final_loss:.4f}")
    except Exception as e:
        print(f"训练过程中出现错误: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()